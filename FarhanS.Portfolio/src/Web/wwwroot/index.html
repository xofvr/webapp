<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FarhanS.Portfolio</title>
    <base href="/" />
    
    <!-- Add preloading for critical resources -->
    <link rel="preload" href="_framework/blazor.webassembly.js" as="script" />
    <link rel="preload" href="css/app.css" as="style" />
    <link rel="preload" href="css/theme.css" as="style" />
    <link rel="preload" href="css/layout.css" as="style" />
    
    <!-- Standard stylesheets -->
    <link rel="stylesheet" href="lib/bootstrap/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="css/app.css" />
    <link rel="stylesheet" href="css/theme.css" />
    <link rel="stylesheet" href="css/layout.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="icon" type="image/png" href="favicon.png" />
    <link href="FarhanS.Portfolio.styles.css" rel="stylesheet" />
    <link href="manifest.webmanifest" rel="manifest" />
    <link rel="apple-touch-icon" sizes="512x512" href="icon-512.png" />
    <link rel="apple-touch-icon" sizes="192x192" href="icon-192.png" />
    
    <!-- Application Insights (wrapped in try-catch to prevent blocking errors) -->
    <script type="text/javascript">
        try {
            !function(T,l,y){var S=T.location,k="script",D="instrumentationKey",C="ingestionendpoint",I="disableExceptionTracking",E="ai.device.",b="toLowerCase",w="crossOrigin",N="POST",e="appInsightsSDK",t=y.name||"appInsights";(y.name||T[e])&&(T[e]=t);var n=T[t]||function(d){var g=!1,f=!1,m={initialize:!0,queue:[],sv:"5",version:2,config:d};function v(e,t){var n={},a="Browser";return n[E+"id"]=a[b](),n[E+"type"]=a,n["ai.operation.name"]=S&&S.pathname||"_unknown_",n["ai.internal.sdkVersion"]="javascript:snippet_"+(m.sv||m.version),{time:function(){var e=new Date;function t(e){var t=""+e;return 1===t.length&&(t="0"+t),t}return e.getUTCFullYear()+"-"+t(1+e.getUTCMonth())+"-"+t(e.getUTCDate())+"T"+t(e.getUTCHours())+":"+t(e.getUTCMinutes())+":"+t(e.getUTCSeconds())+"."+((e.getUTCMilliseconds()/1e3).toFixed(3)+"").slice(2,5)+"Z"}(),iKey:e,name:"Microsoft.ApplicationInsights."+e.replace(/-/g,"")+"."+t,sampleRate:100,tags:n,data:{baseData:{ver:2}}}}var h=d.url||y.src;if(h){function a(e){var t,n,a,i,r,o,s,c,u,p,l;g=!0,m.queue=[],f||(f=!0,t=h,s=function(){var e={},t=d.connectionString;if(t)for(var n=t.split(";"),a=0;a<n.length;a++){var i=n[a].split("=");2===i.length&&(e[i[0][b]()]=i[1])}if(!e[C]){var r=e.endpointsuffix,o=r?e.location:null;e[C]="https://"+(o?o+".":"")+"dc."+(r||"services.visualstudio.com")}return e}(),c=s[D]||d[D]||"",u=s[C],p=u?u+"/v2/track":d.endpointUrl,(l=[]).push((n="SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details)",a=t,i=p,(o=(r=v(c,"Exception")).data).baseType="ExceptionData",o.baseData.exceptions=[{typeName:"SDKLoadFailed",message:n.replace(/\./g,"-"),hasFullStack:!1,stack:n+"\nSnippet failed to load ["+a+"] -- Telemetry is disabled\nHelp Link: https://go.microsoft.com/fwlink/?linkid=2128109\nHost: "+(S&&S.pathname||"_unknown_")+"\nEndpoint: "+i,parsedStack:[]}],r)),l.push(function(e,t,n,a){var i=v(c,"Message"),r=i.data;r.baseType="MessageData";var o=r.baseData;return o.message='AI (Internal): 99 message:"'+("SDK LOAD Failure: Failed to load Application Insights SDK script (See stack for details) ("+n+")").replace(/\"/g,"")+'"',o.properties={endpoint:a},i}(0,0,t,p)),function(e,t){if(JSON){var n=T.fetch;if(n&&!y.useXhr)n(t,{method:N,body:JSON.stringify(e),mode:"cors"});else if(XMLHttpRequest){var a=new XMLHttpRequest;a.open(N,t),a.setRequestHeader("Content-type","application/json"),a.send(JSON.stringify(e))}}}(l,p))}function i(e,t){f||setTimeout(function(){!t&&m.core||a()},500)}var e=function(){var n=l.createElement(k);n.src=h;var e=y[w];return!e&&""!==e||"undefined"==n[w]||(n[w]=e),n.onload=i,n.onerror=a,n.onreadystatechange=function(e,t){"loaded"!==n.readyState&&"complete"!==n.readyState||i(0,t)},n}();y.ld<0?l.getElementsByTagName("head")[0].appendChild(e):setTimeout(function(){l.getElementsByTagName(k)[0].parentNode.appendChild(e)},y.ld||0)}try{m.cookie=l.cookie}catch(p){}function t(e){for(;e.length;)!function(t){m[t]=function(){var e=arguments;g||m.queue.push(function(){m[t].apply(m,e)})}}(e.pop())}var n="track",r="TrackPage",o="TrackEvent";t([n+"Event",n+"PageView",n+"Exception",n+"Trace",n+"DependencyData",n+"Metric",n+"PageViewPerformance","start"+r,"stop"+r,"start"+o,"stop"+o,"addTelemetryInitializer","setAuthenticatedUserContext","clearAuthenticatedUserContext","flush"]),m.SeverityLevel={Verbose:0,Information:1,Warning:2,Error:3,Critical:4};var s=(d.extensionConfig||{}).ApplicationInsightsAnalytics||{};if(!0!==d[I]&&!0!==s[I]){var c="onerror";t(["_"+c]);var u=T[c];T[c]=function(e,t,n,a,i){var r=u&&u(e,t,n,a,i);return!0!==r&&m["_"+c]({message:e,url:t,lineNumber:n,columnNumber:a,error:i}),r},d.autoExceptionInstrumented=!0}return m}(y.cfg);function a(){y.onInit&&y.onInit(n)}(T[t]=n).queue&&0===n.queue.length?(n.queue.push(a),n.trackPageView({})):a()}(window,document,{
                src: "https://js.monitor.azure.com/scripts/b/ai.2.min.js",
                // The SDK is configured through this config object
                cfg: {
                    // Get the connection string from our appsettings.json
                    connectionString: document.appInsightsConnectionString || "", // Will be populated dynamically with environment value
                    /* ...Other optional configurations... */
                    enableDebug: document.location.hostname === "localhost", 
                    disableFetchTracking: false,
                    enableCorsCorrelation: true,
                    enableRequestHeaderTracking: true,
                    enableResponseHeaderTracking: true,
                    disableExceptionTracking: false,
                    autoTrackPageVisitTime: true
                }
            });
        } catch (e) {
            console.log('Application Insights initialization skipped');
        }
    </script>
    
    <!-- Theme JavaScript -->
    <script src="js/theme.js"></script>
</head>

<body>
    <div id="app">
        <svg class="loading-progress">
            <circle r="40%" cx="50%" cy="50%" />
            <circle r="40%" cx="50%" cy="50%" />
        </svg>
        <div class="loading-progress-text"></div>
    </div>

    <div id="blazor-error-ui" style="display: none;">
        An unhandled error has occurred.
        <a href="." class="reload">Reload</a>
        <span class="dismiss">ðŸ—™</span>
    </div>
    
    <!-- Add defer to improve page load performance -->
    <script src="_framework/blazor.webassembly.js" defer></script>
    <script>
        // Register service worker after page load
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function() {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(error) {
                        console.log('Service Worker registration failed:', error);
                    });
            });
        }
        
        // Handle Blazor errors gracefully
        window.addEventListener('unhandledrejection', function(event) {
            console.log('Unhandled Promise Rejection:', event.reason);
            // Prevent the error UI from showing in some cases
            if (event.reason && event.reason.message && 
                event.reason.message.includes('subscriber to the content with the given section ID')) {
                event.preventDefault();
                event.stopPropagation();
            }
        });
        
        // Initialize error handling on page load
        window.addEventListener('load', function() {
            // Hide the Blazor error UI if it appears due to known issues
            const errorUI = document.getElementById('blazor-error-ui');
            if (errorUI) {
                const observer = new MutationObserver(function(mutations) {
                    mutations.forEach(function(mutation) {
                        if (mutation.attributeName === 'style' && 
                            errorUI.style.display === 'block') {
                            // If error UI is shown but app is still functioning, hide it
                            errorUI.style.display = 'none';
                        }
                    });
                });
                
                observer.observe(errorUI, { attributes: true });
            }
        });
    </script>
    
    <!-- Configure Application Insights using the connection string from appsettings -->
    <script>
        (async function () {
            try {
                // Fetch the connection string from appsettings based on environment
                let response = await fetch('appsettings.json');
                let settings = await response.json();
                
                // Look for environment-specific settings first (if available)
                try {
                    // Try to detect environment and load the corresponding settings file
                    let environmentResponse = await fetch('appsettings.' + (window.location.hostname === 'localhost' ? 'Development' : 
                                                          window.location.hostname.includes('staging') ? 'Staging' : 'Production') + '.json');
                    if (environmentResponse.ok) {
                        let envSettings = await environmentResponse.json();
                        // Override base settings with environment-specific ones
                        settings = { ...settings, ...envSettings };
                    }
                } catch (e) {
                    console.log('No environment-specific settings found, using default.');
                }
                
                // Set the connection string for Application Insights
                if (settings && settings.ApplicationInsights && settings.ApplicationInsights.ConnectionString) {
                    document.appInsightsConnectionString = settings.ApplicationInsights.ConnectionString;
                    console.log('Application Insights configured with environment-specific settings');
                }
                
                // Configure the API URL if available
                if (settings && settings.ApiSettings && settings.ApiSettings.BaseUrl) {
                    window.apiBaseUrl = settings.ApiSettings.BaseUrl;
                    console.log(`API Base URL: ${window.apiBaseUrl}`);
                }
            } catch (e) {
                console.error('Error loading application settings', e);
            }
        })();
    </script>
</body>

</html>
